<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scriptoriam: Universal Document Editor</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- FileSaver.js for downloads -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- html2canvas and jspdf for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, deleteDoc, addDoc, setDoc, onSnapshot, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebaseDependencies = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, deleteDoc, addDoc, setDoc, onSnapshot, collection, query, orderBy };
    </script>
    
    <style>
        /* Custom font families for selection */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Georgia:wght@400;700&family=Playfair+Display:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        /* Ensure body and main container take full height */
        html, body, #app-container { height: 100%; }

        /* Custom styles to mimic a document on a page */
        #document-editor {
            min-height: 80vh;
            max-width: 8.5in; 
            margin: 2rem auto;
            background-color: background: linear-gradient(to right, #e32f02, #1034ea);;
            padding: 2rem; 
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            line-height: 1.6;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            outline: none;
            transition: box-shadow 0.3s;
        }
        
        /* Apply large margins only on large screens (desktop) */
        @media (min-width: 1024px) { 
            #document-editor {
                padding: 1.5in 1.5in; 
            }
        }

        /* Styling for the contenteditable area focus */
        #document-editor:focus {
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.6);
        }

        /* Basic styling for rich text elements */
        #document-editor ul { list-style: disc; margin-left: 1.5rem; }
        #document-editor ol { list-style: decimal; margin-left: 1.5rem; }
        #document-editor blockquote { border-left: 6px solid #a5b4fc; padding-left: 1.5rem; margin: 1.5rem 0; color: #4338ca; background-color: #f3f4ff; border-radius: 4px; padding-top: 0.5rem; padding-bottom: 0.5rem;}
        #document-editor h1 { font-size: 2.5em; margin-top: 0.8em; margin-bottom: 0.4em; font-weight: 800; }
        #document-editor h2 { font-size: 1.8em; margin-top: 1em; margin-bottom: 0.5em; font-weight: 700; }
        #document-editor h3 { font-size: 1.3em; margin-top: 1em; margin-bottom: 0.5em; font-weight: 600; }

        /* The toolbar button style */
        .toolbar-btn {
            @apply p-2.5 rounded-xl text-gray-700 hover:bg-indigo-100 transition-colors duration-150 shadow-sm;
        }

        /* File Manager List Item style */
        .file-item {
            @apply flex justify-between items-center p-4 my-3 bg-white hover:bg-indigo-50 border border-gray-200 rounded-xl cursor-pointer transition-all duration-200 shadow-md;
        }
    </style>
</head>
<body class="bg-indigo-50 min-h-screen flex flex-col" id="app-container">

    <!-- Header and Toolbar -->
    <header class="bg-white shadow-lg sticky top-0 z-20">
        <div class="w-full px-4 md:px-8 py-3 flex justify-between items-center">
            
            <!-- Logo & Back Button -->
            <div class="flex items-center space-x-4">
                <h1 class="text-3xl font-extrabold text-indigo-700 tracking-wider">
                    <i class="fas fa-feather-alt mr-1 md:mr-3"></i><span class="hidden sm:inline">Scriptoriam</span>
                </h1>
                <button onclick="switchView('files')" id="back-to-files-btn" class="hidden text-sm md:text-base bg-gray-100 text-gray-700 p-2 md:p-2.5 rounded-xl font-medium hover:bg-gray-200 transition-colors shadow-sm">
                    <i class="fas fa-chevron-left mr-1"></i> My Files
                </button>
            </div>

            <!-- Main Toolbar (Only visible in Editor View) -->
            <div id="main-toolbar" class="flex flex-wrap items-center space-x-2 border-2 p-1.5 rounded-2xl bg-gray-50 shadow-inner overflow-x-auto hidden">
                
                <!-- Font Selectors -->
                <select id="fontName" onchange="formatDoc('fontName', this.value)" class="p-2 rounded-xl border-0 bg-transparent hover:bg-gray-200 text-sm cursor-pointer font-bold w-28 md:w-32">
                    <option value="" disabled selected>Font Family</option>
                    <option value="Inter, sans-serif" style="font-family: Inter, sans-serif;">Inter</option>
                    <option value="Georgia, serif" style="font-family: Georgia, serif;">Georgia</option>
                    <option value="Roboto, sans-serif" style="font-family: Roboto, sans-serif;">Roboto</option>
                    <option value="'Playfair Display', serif" style="font-family: 'Playfair Display', serif;">Playfair</option>
                </select>
                
                <select onchange="formatDoc('fontSize', this.value)" class="p-2 rounded-xl border-0 bg-transparent hover:bg-gray-200 text-sm cursor-pointer font-bold w-16 md:w-20">
                    <option value="" disabled selected>Size</option>
                    <option value="3">12px</option>
                    <option value="4">14px</option>
                    <option value="5">18px</option>
                    <option value="6">24px</option>
                </select>

                <div class="h-8 w-px bg-gray-300 mx-1"></div>

                <!-- Text Formatting -->
                <button class="toolbar-btn" onclick="formatDoc('bold')" title="Bold (Ctrl+B)"><i class="fas fa-bold"></i></button>
                <button class="toolbar-btn" onclick="formatDoc('italic')" title="Italic (Ctrl+I)"><i class="fas fa-italic"></i></button>
                <button class="toolbar-btn hidden sm:block" onclick="formatDoc('underline')" title="Underline (Ctrl+U)"><i class="fas fa-underline"></i></button>
                <button class="toolbar-btn hidden md:block" onclick="formatDoc('strikeThrough')" title="Strikethrough"><i class="fas fa-strikethrough"></i></button>
                
                <div class="h-8 w-px bg-gray-300 mx-1 hidden sm:block"></div>

                <!-- Structure Buttons -->
                <button class="toolbar-btn hidden sm:block" onclick="formatDoc('insertUnorderedList')" title="Bulleted List"><i class="fas fa-list-ul"></i></button>
                <button class="toolbar-btn hidden sm:block" onclick="formatDoc('formatBlock', 'blockquote')" title="Quote Block"><i class="fas fa-quote-right"></i></button>
                <button class="toolbar-btn hidden md:block" onclick="formatDoc('justifyCenter')" title="Align Center"><i class="fas fa-align-center"></i></button>

                <div class="h-8 w-px bg-gray-300 mx-1 hidden sm:block"></div>
                
                <!-- Color Options (Mobile friendly) -->
                <div class="flex flex-col items-center p-1">
                    <label for="foreColor" class="text-xs text-gray-500 font-medium hidden md:block">Text</label>
                    <input type="color" id="foreColor" value="#000000" onchange="formatDoc('foreColor', this.value)" class="w-7 h-7 md:w-8 md:h-8 rounded-full border-none cursor-pointer">
                </div>
            </div>

            <!-- Action Buttons (Visible in both views, adapted) -->
            <div class="flex items-center space-x-3">
                
                <!-- New Document Button (Always visible) -->
                <button onclick="newDocument(true)" class="flex-1 bg-green-500 text-white p-2 md:p-3 rounded-xl text-sm font-medium hover:bg-green-600 transition-colors shadow-lg">
                    <i class="fas fa-plus mr-1"></i> <span class="hidden sm:inline">New</span>
                </button>

                <!-- Save Button (Only visible in Editor View) -->
                <button onclick="saveDocument()" id="save-button" class="hidden bg-indigo-500 text-white p-2 md:p-3 rounded-xl text-sm font-medium hover:bg-indigo-600 transition-colors shadow-lg">
                    <i class="fas fa-save mr-1"></i> <span class="hidden sm:inline">Save</span>
                </button>
                
                <!-- Export Dropdown (Only visible in Editor View) -->
                <div class="relative inline-block text-left hidden" id="export-dropdown-container">
                    <button type="button" class="inline-flex justify-center w-full rounded-xl border border-indigo-700 shadow-lg px-4 md:px-6 py-2 md:py-3 bg-indigo-600 text-sm font-medium text-white hover:bg-indigo-700 transition-all focus:outline-none focus:ring-4 focus:ring-indigo-300" onclick="toggleDropdown()">
                        Export <i class="fas fa-file-export ml-2 mt-0.5"></i>
                    </button>

                    <!-- Dropdown menu -->
                    <div id="export-menu" class="hidden origin-top-right absolute right-0 mt-2 w-56 rounded-xl shadow-2xl bg-white ring-1 ring-black ring-opacity-5 divide-y divide-gray-100 z-30">
                        <div class="py-1" role="none">
                            <a href="#" onclick="exportAs('pdf')" class="text-gray-700 block px-4 py-2 text-sm hover:bg-red-50 hover:text-red-700" role="menuitem">
                                <i class="far fa-file-pdf w-5 mr-2 text-red-600"></i> Download as PDF
                            </a>
                            <a href="#" onclick="exportAs('docx')" class="text-gray-700 block px-4 py-2 text-sm hover:bg-blue-50 hover:text-blue-700" role="menuitem">
                                <i class="far fa-file-word w-5 mr-2 text-blue-600"></i> Download as DOCX
                            </a>
                            <a href="#" onclick="exportAs('html')" class="text-gray-700 block px-4 py-2 text-sm hover:bg-orange-50 hover:text-orange-700" role="menuitem">
                                <i class="far fa-file-code w-5 mr-2 text-orange-500"></i> Download as HTML
                            </a>
                        </div>
                        <div class="py-1" role="none">
                            <a href="#" onclick="exportAs('txt')" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-50" role="menuitem">
                                <i class="far fa-file-alt w-5 mr-2 text-gray-500"></i> Download as TXT
                            </a>
                            <a href="#" onclick="exportAs('bat')" class="text-gray-700 block px-4 py-2 text-sm hover:bg-green-50 hover:text-green-700" role="menuitem">
                                <i class="fas fa-terminal w-5 mr-2 text-green-700"></i> Download as BAT Script
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Area - View Container -->
    <main class="flex-1 overflow-y-auto p-4 md:p-8">
        
        <!-- 1. FILE MANAGER VIEW (Default View) -->
        <div id="file-manager-view" class="max-w-4xl mx-auto h-full p-4 md:p-8 bg-white rounded-2xl shadow-2xl">
            <h2 class="text-3xl font-bold mb-6 text-indigo-800 flex items-center">
                <i class="fas fa-folder-open mr-3"></i> My Universal Files
            </h2>
            <p id="auth-status" class="text-sm text-indigo-500 mb-6 font-mono border-b pb-3 truncate">Connecting...</p>
            
            <div id="file-list" class="space-y-3">
                <!-- Document list will be inserted here by JavaScript -->
                <p class="text-gray-500 text-center py-4">Loading documents...</p>
            </div>
        </div>

        <!-- 2. DOCUMENT EDITOR VIEW -->
        <section id="editor-view" class="hidden">
            <div id="editor-container" class="max-w-5xl mx-auto">
                
                <!-- Title Input -->
                <input type="text" id="doc-title-input" value="My New Document" class="w-full text-4xl font-extrabold text-gray-800 bg-transparent border-b-2 border-transparent focus:border-indigo-500 focus:outline-none mb-4 p-2 rounded-lg transition-colors" placeholder="Document Title">
                
                <!-- Document Editing Area -->
                <div id="document-editor" contenteditable="true" class="document-editable rounded-xl shadow-2xl p-8 bg-white" placeholder="Start writing your universal document here.">
                    <p>Welcome to the enhanced Scriptoriam! Click the "My Files" button above to view saved documents.</p>
                </div>

                <!-- Live Counters -->
                <div class="mt-4 text-gray-600 flex justify-end space-x-6 text-sm">
                    <span id="word-count"><i class="fas fa-font mr-1"></i> Words: 0</span>
                    <span id="char-count"><i class="fas fa-keyboard mr-1"></i> Characters: 0</span>
                    <span id="save-status" class="text-green-600 font-medium hidden"><i class="fas fa-check-circle mr-1"></i> Saved!</span>
                </div>
            </div>
        </section>
    </main>

    <!-- Message Box / Status -->
    <div id="message-box" class="fixed bottom-4 right-4 bg-yellow-500 text-white p-3 rounded-xl shadow-2xl hidden transition-opacity duration-300 opacity-0 z-50"></div>


<script>
    // --- FIREBASE CONFIG & GLOBALS ---
    // Declare all Firebase functions as 'let' globals for later assignment in initializeScriptoriam
    let initializeApp, getAuth, signInAnonymously, signInWithCustomToken, 
        onAuthStateChanged, getFirestore, doc, deleteDoc, addDoc, setDoc, 
        onSnapshot, collection, query, orderBy;

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let db;
    let auth;
    let userId = null;
    let currentDocId = null;
    let currentDocTitle = "My New Document";
    let currentView = 'files'; // Tracks the current visible page: 'files' or 'editor'

    // --- VIEW MANAGEMENT ---

    /**
     * Switches between the 'files' (File Manager) and 'editor' (Document Editor) views.
     */
    function switchView(view) {
        if (currentView === view) return;

        const filesView = document.getElementById('file-manager-view');
        const editorView = document.getElementById('editor-view');
        const toolbar = document.getElementById('main-toolbar');
        const saveButton = document.getElementById('save-button');
        const exportContainer = document.getElementById('export-dropdown-container');
        const backButton = document.getElementById('back-to-files-btn');

        if (view === 'editor') {
            filesView.classList.add('hidden');
            editorView.classList.remove('hidden');
            toolbar.classList.remove('hidden');
            saveButton.classList.remove('hidden');
            exportContainer.classList.remove('hidden');
            backButton.classList.remove('hidden');
            document.getElementById('document-editor').focus();
        } else { // 'files'
            editorView.classList.add('hidden');
            filesView.classList.remove('hidden');
            toolbar.classList.add('hidden');
            saveButton.classList.add('hidden');
            exportContainer.classList.add('hidden');
            backButton.classList.add('hidden');
        }

        currentView = view;
    }


    // --- UTILITY FUNCTIONS ---

    /**
     * Debounce function to limit how often a function runs.
     */
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    /**
     * Displays a temporary status message to the user (instead of alert()).
     */
    function showStatus(message, bgColor = 'bg-gray-800', duration = 3000) {
        const box = document.getElementById('message-box');
        box.textContent = message;
        box.className = `fixed bottom-4 right-4 text-white p-3 rounded-xl shadow-2xl transition-opacity duration-300 opacity-100 ${bgColor}`;
        box.classList.remove('hidden');

        setTimeout(() => {
            box.classList.remove('opacity-100');
            box.classList.add('opacity-0');
            setTimeout(() => box.classList.add('hidden'), 300);
        }, duration);
    }

    /**
     * Updates the word and character counts.
     */
    function updateCounters() {
        const editor = document.getElementById('document-editor');
        const text = editor.textContent.trim();
        
        // Count characters
        const charCount = text.length;
        
        // Count words (split by whitespace and filter out empty strings)
        const wordCount = text ? text.split(/\s+/).filter(word => word.length > 0).length : 0;
        
        document.getElementById('word-count').textContent = `Words: ${wordCount}`;
        document.getElementById('char-count').textContent = `Characters: ${charCount}`;
    }

    // --- FIREBASE & DATA MANAGEMENT ---

    /**
     * Initializes Firebase and handles authentication.
     */
    async function initializeFirebase() {
        // NOTE: Firebase functions (initializeApp, etc.) are guaranteed to be defined here 
        // because of the check in initializeScriptoriam.
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            // setLogLevel('Debug'); // Enable for debugging Firestore

            document.getElementById('auth-status').textContent = 'Authenticating...';

            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('auth-status').textContent = `User ID: ${userId}`;
                    showStatus('Signed in successfully. Loading files.', 'bg-indigo-600');
                    startDocumentListener();
                } else {
                    userId = null;
                    document.getElementById('auth-status').textContent = 'Not authenticated.';
                    showStatus('Authentication failed or user signed out.', 'bg-red-600');
                }
            });

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.getElementById('auth-status').textContent = 'Error initializing Firebase.';
            showStatus(`Firebase Error: ${error.message}`, 'bg-red-800');
        }
    }

    /**
     * Starts listening to all documents for the current user.
     */
    function startDocumentListener() {
        if (!db || !userId) return;

        const path = `artifacts/${appId}/users/${userId}/documents`;
        // Order documents by update time so the most recent ones appear first
        const q = query(collection(db, path), orderBy('updatedAt', 'desc'));

        onSnapshot(q, (snapshot) => {
            const documents = [];
            snapshot.forEach((doc) => {
                const data = doc.data();
                documents.push({ 
                    id: doc.id, 
                    title: data.title,
                    content: data.content,
                    updatedAt: data.updatedAt 
                });
            });
            renderFileList(documents);

            // If a document is open, check if it was deleted (optional, relies on doc list refresh)
            if (currentDocId && !documents.some(d => d.id === currentDocId) && currentView === 'editor') {
                newDocument(true);
            }

        }, (error) => {
            console.error("Error listening to documents:", error);
            showStatus('Failed to load file list.', 'bg-red-500');
        });
    }

    /**
     * Renders the list of documents in the File Manager View.
     */
    function renderFileList(documents) {
        const list = document.getElementById('file-list');
        list.innerHTML = '';
        
        if (documents.length === 0) {
            list.innerHTML = `<p class="text-gray-500 text-center py-12 border border-dashed border-gray-300 rounded-xl">
                <i class="fas fa-exclamation-circle mb-3 text-3xl"></i><br>
                No saved documents yet. Click 'New' to start writing!
            </p>`;
            // If the user has no documents, automatically open a new one initially
            if (!currentDocId) {
                newDocument(false); // Do not clear content on initial load, but switch to editor
            }
            return;
        }

        documents.forEach(doc => {
            const item = document.createElement('div');
            item.className = 'file-item group';
            
            // Document name, updated time, and load handler
            const docInfo = document.createElement('div');
            docInfo.className = "flex-1 mr-4 truncate";
            docInfo.innerHTML = `
                <div onclick="loadDocument('${doc.id}', '${doc.title.replace(/'/g, "\\'")}', '${doc.content.replace(/'/g, "\\'")}')" class="font-bold text-lg text-indigo-700 hover:text-indigo-900 cursor-pointer">
                    <i class="far fa-file-alt mr-2"></i> ${doc.title}
                </div>
                <div class="text-xs text-gray-500 mt-1">
                    <i class="far fa-clock mr-1"></i> Updated: ${new Date(doc.updatedAt?.toDate()).toLocaleString()}
                </div>
            `;
            item.appendChild(docInfo);

            // Delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'text-gray-400 hover:text-red-600 p-2 rounded-full transition-colors opacity-0 group-hover:opacity-100';
            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
            deleteBtn.title = `Delete ${doc.title}`;
            deleteBtn.onclick = (e) => {
                e.stopPropagation(); // Prevent loading the document when clicking delete
                confirmDelete(doc.id, doc.title);
            };
            item.appendChild(deleteBtn);

            list.appendChild(item);
        });
    }
    
    /**
     * Deletes a document after confirmation.
     */
    function confirmDelete(id, title) {
        // Simple confirmation modal/logic since window.confirm is forbidden
        if (window.confirm(`Are you sure you want to delete the document: "${title}"? This cannot be undone.`)) {
            deleteDocument(id, title);
        }
    }

    async function deleteDocument(id, title) {
        if (!db || !userId) return;

        try {
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/documents`, id);
            await deleteDoc(docRef);

            // If the deleted document was the one currently open, open a new one and switch to files view
            if (currentDocId === id) {
                newDocument(true); 
                switchView('files');
            }

            showStatus(`Document "${title}" deleted.`, 'bg-red-600', 3000);
        } catch (error) {
            console.error("Error deleting document:", error);
            showStatus(`Failed to delete document: ${title}`, 'bg-red-800', 4000);
        }
    }


    /**
     * Loads a document into the editor and switches view.
     */
    function loadDocument(id, title, content) {
        currentDocId = id;
        currentDocTitle = title;
        document.getElementById('doc-title-input').value = title;
        document.getElementById('document-editor').innerHTML = content;
        updateCounters();
        switchView('editor');
        showStatus(`Loaded document: ${title}`, 'bg-indigo-600', 2000);
    }

    /**
     * Creates a blank new document and switches view.
     */
    function newDocument(clearContent = true) {
        currentDocId = null; // Mark as new document
        currentDocTitle = `New Document - ${new Date().toLocaleString().split(',')[0]}`;
        document.getElementById('doc-title-input').value = currentDocTitle;
        // Reset color pickers
        document.getElementById('foreColor').value = "#000000";
        // NOTE: The 'backColor' element does not exist in the HTML, commenting out to prevent errors.
        // document.getElementById('backColor').value = "#ffffff";
        if (clearContent) {
            document.getElementById('document-editor').innerHTML = '<p>Start your new masterpiece here...</p>';
        }
        updateCounters();
        switchView('editor');
        showStatus('New document initialized.', 'bg-green-500', 1500);
    }

    /**
     * Saves the current document (or creates a new one).
     */
    async function saveDocument() {
        if (!userId) {
            showStatus('Authentication in progress. Please wait.', 'bg-yellow-600');
            return;
        }

        const editorContent = document.getElementById('document-editor').innerHTML;
        const editorTitle = document.getElementById('doc-title-input').value.trim() || "Untitled Document";
        
        const saveButton = document.getElementById('save-button');
        const saveStatus = document.getElementById('save-status');

        saveButton.disabled = true;
        saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Saving...';
        saveStatus.classList.remove('hidden');
        saveStatus.textContent = 'Saving...';
        saveStatus.classList.remove('text-green-600', 'text-red-600');
        saveStatus.classList.add('text-yellow-600');

        const docData = {
            title: editorTitle,
            content: editorContent,
            updatedAt: new Date(),
        };

        try {
            if (currentDocId) {
                // Update existing document
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/documents`, currentDocId);
                await setDoc(docRef, docData, { merge: true });
            } else {
                // Create new document
                const docRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/documents`), {
                    ...docData,
                    createdAt: new Date(),
                });
                currentDocId = docRef.id;
            }
            
            currentDocTitle = editorTitle;
            document.getElementById('doc-title-input').value = currentDocTitle; // Ensure cleaned title is set

            saveStatus.textContent = 'Saved!';
            saveStatus.classList.remove('text-yellow-600');
            saveStatus.classList.add('text-green-600');
            showStatus(`Document "${editorTitle}" saved successfully!`, 'bg-green-700', 2000);

        } catch (error) {
            console.error("Error saving document:", error);
            saveStatus.textContent = 'Save Failed!';
            saveStatus.classList.remove('text-green-600');
            saveStatus.classList.add('text-red-600');
            showStatus(`Failed to save document. Check console.`, 'bg-red-700', 4000);
        } finally {
            saveButton.disabled = false;
            saveButton.innerHTML = '<i class="fas fa-save mr-1"></i> <span class="hidden sm:inline">Save</span>';
            setTimeout(() => saveStatus.classList.add('hidden'), 3000);
        }
    }

    // Auto-save logic (debounced)
    const autoSave = debounce(saveDocument, 3000);


    // --- EDITOR AND FORMATTING LOGIC ---

    /**
     * Initializes the document editor and sets up event listeners.
     */
    function initializeScriptoriam() {
        // --- Dependency Assignment MUST happen first to avoid Error 1 ---
        const dependencies = window.firebaseDependencies;
        if (dependencies) {
            // Assign global Firebase function variables
            ({ initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, deleteDoc, addDoc, setDoc, onSnapshot, collection, query, orderBy } = dependencies);
            initializeFirebase(); // Start Firebase services and auth listener
        } else {
             console.error("CRITICAL ERROR: Firebase dependencies not available. App cannot function.");
        }
        // -----------------------------------------------------------------


        const editor = document.getElementById('document-editor');
        const titleInput = document.getElementById('doc-title-input');

        // Set up main input listener for autosave and counters
        editor.addEventListener('input', () => {
            updateCounters();
            autoSave();
        });

        // Set up title input listener for autosave
        titleInput.addEventListener('input', () => {
            autoSave();
        });

        updateCounters();
        switchView('files'); // Start on the file manager view
    }

    /**
     * Executes a formatting command on the selected text.
     */
    function formatDoc(command, value = null) {
        document.execCommand(command, false, value);
        document.getElementById('document-editor').focus();
    }

    // Toggles the export dropdown menu visibility
    function toggleDropdown() {
        document.getElementById('export-menu').classList.toggle('hidden');
    }

    // Hide dropdown when clicking outside
    document.addEventListener('click', (event) => {
        const dropdown = document.getElementById('export-menu');
        const container = document.getElementById('export-dropdown-container');
        if (container && !container.contains(event.target) && !dropdown.classList.contains('hidden')) {
            dropdown.classList.add('hidden');
        }
    });

    // --- EXPORT LOGIC ---

    function exportAs(format) {
        document.getElementById('export-menu').classList.add('hidden');
        const title = document.getElementById('doc-title-input').value || "Scriptoriam_Document";

        switch (format) {
            case 'txt': exportAsTxt(title); break;
            case 'html': exportAsHtml(title); break;
            case 'docx': exportAsDocx(title); break;
            case 'pdf': exportAsPdf(title); break;
            case 'bat': exportAsBat(title); break;
            default: showStatus(`Unknown export format: ${format}`, 'bg-red-500');
        }
    }

    function downloadFile(filename, content, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        saveAs(blob, filename);
        showStatus(`Successfully downloaded ${filename}!`, 'bg-green-600', 2500);
    }

    function exportAsTxt(title) {
        const content = document.getElementById('document-editor').textContent;
        downloadFile(`${title}.txt`, content, 'text/plain;charset=utf-8');
    }

    function exportAsHtml(title) {
        const content = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    <style>
        body { font-family: Inter, sans-serif; line-height: 1.6; max-width: 800px; margin: 40px auto; padding: 20px; }
        h1, h2, h3 { margin-top: 1.5em; }
        ul { list-style: disc; margin-left: 1.5rem; }
        ol { list-style: decimal; margin-left: 1.5rem; }
        blockquote { border-left: 6px solid #a5b4fc; padding-left: 1.5rem; margin: 1.5rem 0; color: #4338ca; background-color: #f3f4ff; border-radius: 4px; padding-top: 0.5rem; padding-bottom: 0.5rem;}
    </style>
</head>
<body>
    ${document.getElementById('document-editor').innerHTML}
</body>
</html>`;
        downloadFile(`${title}.html`, content, 'text/html;charset=utf-8');
    }

    function exportAsDocx(title) {
        const htmlContent = `
<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
<head>
    <meta charset='utf-8'>
    <title>${title}</title>
    <style>
        body { font-family: Calibri, Arial, sans-serif; line-height: 1.5; margin: 1in; }
    </style>
</head>
<body>
    ${document.getElementById('document-editor').innerHTML}
</body>
</html>`;
        downloadFile(`${title}.doc`, htmlContent, 'application/msword;charset=utf-8');
    }

    async function exportAsPdf(title) {
        showStatus('Generating PDF... please wait.', 'bg-yellow-500', 5000);
        
        const { jsPDF } = window.jspdf;
        const editor = document.getElementById('document-editor');
        
        // Temporarily adjust padding for the screenshot, then restore
        const originalPadding = editor.style.padding;
        editor.style.padding = '50px'; 

        try {
            const canvas = await html2canvas(editor, { scale: 2, logging: false, useCORS: true });
            editor.style.padding = originalPadding;

            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4'); 
            const imgWidth = 210; 
            const pageHeight = 295; 
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            while (heightLeft >= -5) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            pdf.save(`${title}.pdf`);
            showStatus('PDF successfully created!', 'bg-green-600', 2500);
        } catch (e) {
             editor.style.padding = originalPadding; // Ensure padding is restored on error
             console.error("PDF generation failed:", e);
             showStatus('PDF generation failed. Try exporting as DOCX.', 'bg-red-700', 4000);
        }
    }

    function exportAsBat(title) {
        const cleanContent = document.getElementById('document-editor').textContent.split('\n').map(line => {
            // Escape special characters for batch script
            let escapedLine = line.replace(/&/g, '^&').replace(/\|/g, '^|').replace(/>/g, '^>').replace(/</g, '^<');
            return `echo ${escapedLine}`;
        }).join('\r\n');

        const batContent = `@echo off
title Scriptoriam Document: ${title}
echo.
echo ========================================================
echo.
${cleanContent}
echo.
echo ========================================================
echo.
pause
exit`;
        downloadFile(`${title}.bat`, batContent, 'text/x-batch;charset=us-ascii');
    }

    // Initialize the application once the window loads
    window.onload = initializeScriptoriam;

    // Expose functions globally for HTML access
    window.switchView = switchView;
    window.newDocument = newDocument;
    window.saveDocument = saveDocument;
    window.loadDocument = loadDocument;
    window.confirmDelete = confirmDelete;
    window.formatDoc = formatDoc;
    window.toggleDropdown = toggleDropdown;
    window.exportAs = exportAs;

</script>
</body>
</html>
